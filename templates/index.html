{% extends "base.html" %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section" style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: white; padding: 80px 0;">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <!-- Logo and Branding -->
                <div class="mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="logo-square me-3" style="width: 60px; height: 60px; background: #ffd700; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #1a1a1a; font-weight: bold;">
                            <div style="font-size: 10px;">MRI QA</div>
                            <div style="font-size: 14px; font-weight: 900;">MRsim</div>
                            <div style="font-size: 8px;">QC</div>
                        </div>
                        <div>
                            <h2 style="color: #ffd700; font-weight: 700; margin: 0;">SpinTecX</h2>
                            <p style="color: #ccc; margin: 0; font-size: 14px;">Precision MRI Diagnosis & Therapy</p>
                        </div>
                    </div>
                </div>
                
                <!-- Main Heading -->
                <h1 class="display-4 mb-4" style="font-weight: 700; line-height: 1.2;">
                    MRsim QC - Advanced MRI Distortion Analysis
                </h1>
                
                <!-- Description -->
                <p class="lead mb-4" style="color: #e0e0e0; font-size: 1.1em; line-height: 1.6;">
                    Professional-grade MRI quality control and distortion analysis. Upload your DICOM files to detect geometric distortions, analyze B0 field maps, and generate comprehensive QA reports for clinical validation.
                </p>
                
                <!-- Call to Action Buttons -->
                <div class="d-flex gap-3 mb-4">
                    <button class="btn btn-lg" style="background: #ffd700; color: #1a1a1a; border: none; padding: 12px 30px; font-weight: 600; border-radius: 6px;" onclick="scrollToUpload()">
                        Start Analysis
                    </button>
                    <button class="btn btn-lg" style="background: transparent; color: white; border: 2px solid #ffd700; padding: 12px 30px; font-weight: 600; border-radius: 6px;" onclick="showHelp()">
                        How It Works
                    </button>
                </div>
            </div>
            
            <!-- Right Side - MRI Images -->
            <div class="col-lg-6">
                <div class="position-relative">
                    <!-- MRI Scanner Image Placeholder -->
                    <div style="background: linear-gradient(45deg, #333, #555); border-radius: 15px; height: 300px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; position: relative; overflow: hidden;">
                        <div style="color: #ffd700; font-size: 48px;">ðŸ§²</div>
                        <div style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                            MRI SCANNER
                        </div>
                    </div>
                    
                    <!-- Distortion Detection Image Placeholder -->
                    <div style="background: linear-gradient(45deg, #444, #666); border-radius: 15px; height: 200px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                        <div style="color: #ffd700; font-size: 36px;">ðŸ§ </div>
                        <div style="position: absolute; top: 15px; right: 15px; background: #ff4444; color: white; padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: bold;">
                            DISTORTION DETECTED
                        </div>
                        <div style="position: absolute; bottom: 15px; left: 15px; background: rgba(0,0,0,0.7); color: #ffd700; padding: 4px 8px; border-radius: 10px; font-size: 10px;">
                            AI Analysis Active
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<!-- Upload Section -->
<section class="py-5" style="background: #2d2d2d; color: white;" id="upload-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card" style="background: #1a1a1a; border: none; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                    <div class="card-header" style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #1a1a1a; border-radius: 20px 20px 0 0; padding: 25px;">
                        <h4 class="mb-0" style="font-weight: 700;">
                            <i class="fas fa-cloud-upload-alt me-2"></i>MRsim QC - Upload DICOM Files
                        </h4>
                        <p class="mb-0 mt-2" style="font-size: 0.9em; opacity: 0.8;">
                            Upload your MRI data for professional distortion analysis and quality control
                        </p>
                    </div>
                    <div class="card-body" style="padding: 40px;">
                        <form action="/upload" method="post" enctype="multipart/form-data" id="upload-form">
                            <div class="upload-area" id="upload-area" style="background: #2d2d2d; border: 2px dashed #ffd700; border-radius: 15px; padding: 40px; text-align: center; transition: all 0.3s ease;">
                                <i class="fas fa-cloud-upload-alt fa-4x mb-3" style="color: #ffd700;"></i>
                                <h5 style="color: white; margin-bottom: 15px;">Drag & Drop DICOM Files or Folders Here</h5>
                                <p style="color: #ccc; margin-bottom: 20px;">or click to browse files/folders</p>
                                <input type="file" id="file-input" name="files" multiple accept=".dcm" class="d-none">
                                <input type="file" id="folder-input" name="files" multiple accept=".dcm" webkitdirectory class="d-none">
                                <div class="mt-3">
                                    <div class="btn-group" role="group" style="flex-wrap: wrap; gap: 10px;">
                                        <button type="button" class="btn" onclick="document.getElementById('file-input').click()" style="background: #ffd700; color: #1a1a1a; border: none; padding: 10px 20px; font-weight: 600; border-radius: 6px;">
                                            <i class="fas fa-file-medical me-2"></i>Browse Files
                                        </button>
                                        <button type="button" class="btn" onclick="document.getElementById('folder-input').click()" style="background: #ffd700; color: #1a1a1a; border: none; padding: 10px 20px; font-weight: 600; border-radius: 6px;">
                                            <i class="fas fa-folder me-2"></i>Browse Folders
                                        </button>
                                        <button type="button" class="btn" onclick="clearAllUploads()" style="background: transparent; color: #ff6b6b; border: 2px solid #ff6b6b; padding: 10px 20px; font-weight: 600; border-radius: 6px;">
                                            <i class="fas fa-trash me-2"></i>Clear All
                                        </button>
                                    </div>
                                    <div class="mt-3">
                                        <p class="text-muted mb-0">
                                            <small>Upload your DICOM files above to start the analysis</small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h6>Required Files:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success me-2"></i>Magnitude images at TE1 (e.g., 10ms)</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Magnitude images at TE2 (e.g., 15ms)</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Phase difference images</li>
                                </ul>
                            </div>
                            
                            <!-- Status Cards -->
                            <div class="mt-4" id="status-cards" style="display: none;">
                                <h6 style="color: white; font-weight: 600; margin-bottom: 20px;">Upload Status:</h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="card" id="te1-status-card" style="background: #2d2d2d; border: 2px solid #ffd700; border-radius: 12px;">
                                            <div class="card-body text-center p-3">
                                                <i class="fas fa-hourglass-half fa-2x mb-2" style="color: #ffd700;"></i>
                                                <h6 class="card-title mb-1" style="color: white;">Magnitude TE=10ms</h6>
                                                <small style="color: #ccc;">Not uploaded</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card" id="te2-status-card" style="background: #2d2d2d; border: 2px solid #ffd700; border-radius: 12px;">
                                            <div class="card-body text-center p-3">
                                                <i class="fas fa-hourglass-half fa-2x mb-2" style="color: #ffd700;"></i>
                                                <h6 class="card-title mb-1" style="color: white;">Magnitude TE=15ms</h6>
                                                <small style="color: #ccc;">Not uploaded</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card" id="phase-status-card" style="background: #2d2d2d; border: 2px solid #ffd700; border-radius: 12px;">
                                            <div class="card-body text-center p-3">
                                                <i class="fas fa-hourglass-half fa-2x mb-2" style="color: #ffd700;"></i>
                                                <h6 class="card-title mb-1" style="color: white;">Phase Difference</h6>
                                                <small style="color: #ccc;">Not uploaded</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Upload Progress -->
                            <div class="upload-progress mt-4" id="upload-progress" style="display: none;">
                                <h6><i class="fas fa-upload me-2"></i>Upload Progress</h6>
                                <div class="progress mb-2">
                                    <div class="progress-bar" role="progressbar" style="width: 0%" id="upload-bar"></div>
                                </div>
                                <small class="text-muted" id="upload-status">Preparing upload...</small>
                                
                                <!-- File List -->
                                <div class="mt-3" id="file-list">
                                    <h6><i class="fas fa-files me-2"></i>Uploaded Files</h6>
                                    <div id="file-items"></div>
                                </div>
                            </div>
                            
                            <!-- Processing Status -->
                            <div class="loading text-center mt-4" id="loading" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Processing...</span>
                                </div>
                                <p class="mt-2" id="processing-status">Processing your DICOM files...</p>
                                
                                <!-- Processing Steps -->
                                <div class="mt-3" id="processing-steps">
                                    <div class="step-item" id="step-1">
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <span>Loading DICOM files...</span>
                                    </div>
                                    <div class="step-item" id="step-2">
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <span>Estimating B0 field map...</span>
                                    </div>
                                    <div class="step-item" id="step-3">
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <span>Calculating distortion map...</span>
                                    </div>
                                    <div class="step-item" id="step-4">
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <span>Generating visualizations...</span>
                                    </div>
                                    <div class="step-item" id="step-5">
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <span>Creating analysis report...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-lg" id="submit-btn" style="background: #ffd700; color: #1a1a1a; border: none; padding: 15px 40px; font-weight: 700; border-radius: 8px; font-size: 1.1em;">
                                    <i class="fas fa-play me-2"></i>Start Analysis
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- How It Works Section -->
<section class="py-5" style="background: #2d2d2d; color: white;" id="how-it-works">
    <div class="container">
        <div class="row text-center mb-5">
            <div class="col-12">
                <h2 class="mb-3" style="color: white; font-weight: 700;">How MRsim QC Works</h2>
                <p style="color: #ccc;">Professional 3-step process for comprehensive MRI distortion analysis</p>
            </div>
        </div>
        
        <div class="row g-4">
            <div class="col-md-4">
                <div class="text-center">
                    <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px; background: #ffd700; color: #1a1a1a;">
                        <span class="h4 mb-0" style="font-weight: 700;">1</span>
                    </div>
                    <h5 style="color: white;">Upload DICOM Data</h5>
                    <p style="color: #ccc;">Upload magnitude images at different TEs (10ms, 15ms) and phase difference DICOM files</p>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="text-center">
                    <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px; background: #ffd700; color: #1a1a1a;">
                        <span class="h4 mb-0" style="font-weight: 700;">2</span>
                    </div>
                    <h5 style="color: white;">AI Analysis</h5>
                    <p style="color: #ccc;">Advanced algorithms estimate B0 field maps, unwrap phase data, and calculate geometric distortions</p>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="text-center">
                    <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px; background: #ffd700; color: #1a1a1a;">
                        <span class="h4 mb-0" style="font-weight: 700;">3</span>
                    </div>
                    <h5 style="color: white;">QA Reports</h5>
                    <p style="color: #ccc;">Download comprehensive distortion maps, 3D visualizations, and clinical validation reports</p>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// File upload tracking
let uploadedFiles = [];
let selectedFolders = {};
let currentStep = 0;

// File input change handler
document.getElementById('file-input').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    console.log('Files selected:', files.length, 'files');
    handleFileSelection(files);
    showUploadProgress();
});

// Folder input change handler
document.getElementById('folder-input').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    console.log('Folder selected:', files.length, 'files');
    handleFolderSelection(files);
    showUploadProgress();
});

// Drag and drop visual feedback
document.getElementById('upload-area').addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
});

document.getElementById('upload-area').addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
});

// Drag and drop file handler
document.getElementById('upload-area').addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    
    console.log('Drop event triggered');
    
    // Get all files from the drop
    const items = Array.from(e.dataTransfer.items);
    const files = [];
    
    console.log('Processing', items.length, 'dropped items');
    
    // Process each item (file or folder)
    const processEntry = (entry, path = '') => {
        return new Promise((resolve) => {
            if (entry.isFile) {
                // Single file
                entry.file(file => {
                    if (file && file.name.toLowerCase().endsWith('.dcm')) {
                        // Preserve the folder structure in webkitRelativePath
                        const relativePath = path ? `${path}${file.name}` : file.name;
                        Object.defineProperty(file, 'webkitRelativePath', {
                            value: relativePath,
                            writable: false
                        });
                        files.push(file);
                        console.log('Added file:', relativePath);
                    }
                    resolve();
                });
            } else if (entry.isDirectory) {
                // Folder - read its contents
                console.log('Processing folder:', entry.name);
                const dirReader = entry.createReader();
                dirReader.readEntries(entries => {
                    const promises = entries.map(subEntry => 
                        processEntry(subEntry, path + entry.name + '/')
                    );
                    Promise.all(promises).then(() => resolve());
                });
            } else {
                resolve();
            }
        });
    };
    
    // Process all dropped items
    const promises = items.map(item => {
        if (item.kind === 'file') {
            const entry = item.webkitGetAsEntry();
            if (entry) {
                return processEntry(entry);
            }
        }
        return Promise.resolve();
    });
    
    Promise.all(promises).then(() => {
        console.log('Total files found:', files.length);
        
        if (files.length > 0) {
            // Use the new merging logic for drag and drop
            handleFileSelection(files);
            showUploadProgress();
        } else {
            // Fallback: try to get files from e.dataTransfer.files
            console.log('No files found via File System Access API, trying fallback');
            const fallbackFiles = Array.from(e.dataTransfer.files).filter(file => 
                file.name.toLowerCase().endsWith('.dcm')
            );
            
            if (fallbackFiles.length > 0) {
                console.log('Found', fallbackFiles.length, 'files via fallback');
                handleFileSelection(fallbackFiles);
                showUploadProgress();
            } else {
                console.log('No DICOM files found in dropped items');
                alert('No DICOM files (.dcm) found in the dropped items. Please ensure you are dropping folders containing .dcm files, or use the "Browse Folders" button instead.');
            }
        }
    });
});

function handleFileSelection(files) {
    const folders = {};
    
    Array.from(files).forEach(file => {
        let folderName = 'Unknown Series';
        
        if (file.webkitRelativePath) {
            folderName = file.webkitRelativePath.split('/')[0];
        } else {
            const fileName = file.name.toLowerCase();
            if (fileName.includes('te10') || fileName.includes('te_10')) {
                folderName = 'Magnitude TE=10ms';
            } else if (fileName.includes('te15') || fileName.includes('te_15')) {
                folderName = 'Magnitude TE=15ms';
            } else if (fileName.includes('phase') || fileName.includes('diff')) {
                folderName = 'Phase Difference';
            }
        }
        
        if (!folders[folderName]) {
            folders[folderName] = [];
        }
        folders[folderName].push(file);
    });
    
    // Merge with existing selectedFolders instead of overwriting
    selectedFolders = { ...selectedFolders, ...folders };
    
    // Update uploadedFiles array with all files
    uploadedFiles = Object.values(selectedFolders).flat();
    
    displayFileList();
}

function handleFolderSelection(files) {
    const folders = {};
    
    Array.from(files).forEach(file => {
        const path = file.webkitRelativePath;
        const folderName = path.split('/')[0];
        
        if (!folders[folderName]) {
            folders[folderName] = [];
        }
        folders[folderName].push(file);
    });
    
    // Merge with existing selectedFolders instead of overwriting
    selectedFolders = { ...selectedFolders, ...folders };
    
    // Update uploadedFiles array with all files
    uploadedFiles = Object.values(selectedFolders).flat();
    
    displayFileList();
}

function displayFileList() {
    const fileItems = document.getElementById('file-items');
    fileItems.innerHTML = '';
    
    console.log('=== DISPLAYING FILE LIST ===');
    console.log('selectedFolders:', Object.keys(selectedFolders));
    
    // Display only folder names and file counts (no individual files)
    Object.keys(selectedFolders).forEach(seriesName => {
        const seriesDiv = document.createElement('div');
        seriesDiv.className = 'file-item mb-2';
        seriesDiv.id = `series-${seriesName.replace(/[^a-zA-Z0-9]/g, '-')}`;
        seriesDiv.innerHTML = `
            <i class="fas fa-folder text-primary me-2"></i>
            <span class="file-name">${seriesName}</span>
            <span class="badge bg-primary ms-auto">${selectedFolders[seriesName].length} files</span>
            <span class="file-status ms-2" id="status-${seriesName.replace(/[^a-zA-Z0-9]/g, '-')}">
                <i class="fas fa-hourglass-start text-muted"></i>
            </span>
        `;
        fileItems.appendChild(seriesDiv);
    });
    
    // Update status cards
    updateStatusCards();
}

function updateStatusCards() {
    const statusCards = document.getElementById('status-cards');
    const te1Card = document.getElementById('te1-status-card');
    const te2Card = document.getElementById('te2-status-card');
    const phaseCard = document.getElementById('phase-status-card');
    
    // Show status cards if we have files
    if (Object.keys(selectedFolders).length > 0) {
        statusCards.style.display = 'block';
    }
    
    console.log('=== UPDATING STATUS CARDS ===');
    console.log('Available folders:', Object.keys(selectedFolders));
    
    // Check for TE1 - more flexible matching
    const te1Found = findSeries('te10') || findSeries('te_10') || findSeries('10') || 
                   findSeries('magnitude') && (findSeries('10') || findSeries('te10'));
    console.log('TE1 found:', te1Found);
    updateStatusCard(te1Card, te1Found, 'Magnitude TE=10ms');
    
    // Check for TE2 - more flexible matching
    const te2Found = findSeries('te15') || findSeries('te_15') || findSeries('15') || 
                   findSeries('magnitude') && (findSeries('15') || findSeries('te15'));
    console.log('TE2 found:', te2Found);
    updateStatusCard(te2Card, te2Found, 'Magnitude TE=15ms');
    
    // Check for Phase - more flexible matching
    const phaseFound = findSeries('phase') || findSeries('diff') || findSeries('difference');
    console.log('Phase found:', phaseFound);
    updateStatusCard(phaseCard, phaseFound, 'Phase Difference');
    
    console.log('=== END STATUS CARDS UPDATE ===');
}

function findSeries(keyword) {
    return Object.keys(selectedFolders).some(name => 
        name.toLowerCase().includes(keyword.toLowerCase())
    );
}

function updateStatusCard(card, found, title) {
    if (found) {
        card.style.background = '#2d2d2d';
        card.style.border = '2px solid #28a745';
        card.querySelector('i').className = 'fas fa-check-circle fa-2x mb-2';
        card.querySelector('i').style.color = '#28a745';
        card.querySelector('h6').textContent = title;
        card.querySelector('small').textContent = 'Uploaded';
        card.querySelector('small').style.color = '#28a745';
    } else {
        card.style.background = '#2d2d2d';
        card.style.border = '2px solid #ffd700';
        card.querySelector('i').className = 'fas fa-hourglass-half fa-2x mb-2';
        card.querySelector('i').style.color = '#ffd700';
        card.querySelector('h6').textContent = title;
        card.querySelector('small').textContent = 'Not uploaded';
        card.querySelector('small').style.color = '#ccc';
    }
}

function scrollToUpload() {
    document.getElementById('upload-section').scrollIntoView({ 
        behavior: 'smooth' 
    });
}

function showHelp() {
    document.getElementById('how-it-works').scrollIntoView({ 
        behavior: 'smooth' 
    });
}


function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showUploadProgress() {
    document.getElementById('upload-progress').style.display = 'block';
    updateUploadStatus('Ready to upload ' + uploadedFiles.length + ' files');
}

function updateUploadStatus(message) {
    document.getElementById('upload-status').textContent = message;
}

function updateUploadProgress(percent) {
    const progressBar = document.getElementById('upload-bar');
    progressBar.style.width = percent + '%';
    progressBar.setAttribute('aria-valuenow', percent);
    
    // Update status text
    const statusText = document.getElementById('upload-status');
    if (percent < 100) {
        statusText.textContent = `Uploading... ${Math.round(percent)}%`;
    } else {
        statusText.textContent = 'Upload complete! Processing files...';
    }
}

function resetForm() {
    document.getElementById('submit-btn').disabled = false;
    document.getElementById('submit-btn').innerHTML = '<i class="fas fa-play me-2"></i>Start Analysis';
    document.getElementById('loading').classList.remove('show');
    document.getElementById('upload-progress').style.display = 'none';
    document.getElementById('file-items').innerHTML = '';
    document.getElementById('file-input').value = '';
    document.getElementById('folder-input').value = '';
    uploadedFiles = [];
}

function markFileAsUploading(fileName) {
    const fileItem = document.getElementById(`file-${fileName}`);
    if (fileItem) {
        fileItem.classList.add('uploading');
        fileItem.querySelector('.fa-check-circle').style.display = 'none';
        fileItem.querySelector('.fa-spinner').style.display = 'inline';
    }
}

function markFileAsCompleted(fileName) {
    const fileItem = document.getElementById(`file-${fileName}`);
    if (fileItem) {
        fileItem.classList.remove('uploading');
        fileItem.classList.add('completed');
        fileItem.querySelector('.fa-spinner').style.display = 'none';
        fileItem.querySelector('.fa-check-circle').style.display = 'inline';
    }
}

function updateProcessingStep(stepNumber, status = 'active') {
    // Reset all steps
    for (let i = 1; i <= 5; i++) {
        const step = document.getElementById(`step-${i}`);
        step.classList.remove('active', 'completed');
        step.querySelector('i').className = 'fas fa-circle text-muted me-2';
    }
    
    // Update current and previous steps
    for (let i = 1; i <= stepNumber; i++) {
        const step = document.getElementById(`step-${i}`);
        if (i < stepNumber) {
            step.classList.add('completed');
            step.querySelector('i').className = 'fas fa-check-circle text-success me-2';
        } else {
            step.classList.add(status);
            if (status === 'completed') {
                step.querySelector('i').className = 'fas fa-check-circle text-success me-2';
            } else {
                step.querySelector('i').className = 'fas fa-circle text-primary me-2';
            }
        }
    }
}

// Form submission handler
document.getElementById('upload-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Check if we have any files in selectedFolders
    const totalFiles = Object.values(selectedFolders).flat().length;
    
    console.log('Form submission - selectedFolders:', Object.keys(selectedFolders));
    console.log('Form submission - total files:', totalFiles);
    
    if (totalFiles === 0) {
        console.log('No files found, showing alert');
        alert('Please select files to upload');
        return;
    }
    
    // Use all files from selectedFolders
    uploadedFiles = Object.values(selectedFolders).flat();
    console.log('Final files to upload:', uploadedFiles.length);
    
    // Show upload progress (not processing yet)
    document.getElementById('upload-progress').style.display = 'block';
    document.getElementById('loading').classList.remove('show');
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('submit-btn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
    
    // Actually submit the form with real progress tracking
    setTimeout(() => {
        const formData = new FormData();
        
        // Add all uploaded files to form data
        uploadedFiles.forEach(file => {
            formData.append('files', file);
        });
        
        console.log('Submitting form with', uploadedFiles.length, 'files');
        
        // Use XMLHttpRequest for real progress tracking
        const xhr = new XMLHttpRequest();
        
        // Track upload progress
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                updateUploadProgress(percentComplete);
                console.log('Upload progress:', percentComplete.toFixed(2) + '%');
            }
        });
        
        // Handle successful upload
        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                console.log('Upload completed successfully');
                updateUploadProgress(100);
                
                // Show processing steps
                document.getElementById('upload-progress').style.display = 'none';
                document.getElementById('loading').classList.add('show');
                document.getElementById('submit-btn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
                
                // Simulate processing steps
                updateProcessingStep(1, 'active');
                document.getElementById('processing-status').textContent = 'Loading DICOM files...';
                
                setTimeout(() => {
                    updateProcessingStep(2, 'active');
                    document.getElementById('processing-status').textContent = 'Estimating B0 field map...';
                }, 1000);
                
                setTimeout(() => {
                    updateProcessingStep(3, 'active');
                    document.getElementById('processing-status').textContent = 'Calculating distortion map...';
                }, 2000);
                
                setTimeout(() => {
                    updateProcessingStep(4, 'active');
                    document.getElementById('processing-status').textContent = 'Generating visualizations...';
                }, 3000);
                
                setTimeout(() => {
                    updateProcessingStep(5, 'active');
                    document.getElementById('processing-status').textContent = 'Creating analysis report...';
                }, 4000);
                
                // Redirect to results page after processing simulation
                setTimeout(() => {
                    window.location.href = xhr.responseURL;
                }, 5000);
            } else {
                console.error('Upload failed with status:', xhr.status);
                alert('Upload failed. Please try again.');
                resetForm();
            }
        });
        
        // Handle upload errors
        xhr.addEventListener('error', function() {
            console.error('Upload error occurred');
            alert('Upload failed. Please check your connection and try again.');
            resetForm();
        });
        
        // Start the upload
        xhr.open('POST', '/upload');
        xhr.send(formData);
        
    }, 500);
});


function clearAllUploads() {
    // Clear all data
    selectedFolders = {};
    uploadedFiles = [];
    
    // Clear file inputs
    document.getElementById('file-input').value = '';
    document.getElementById('folder-input').value = '';
    
    // Hide status cards
    document.getElementById('status-cards').style.display = 'none';
    
    // Clear file list
    document.getElementById('file-items').innerHTML = '';
    
    // Hide upload progress
    document.getElementById('upload-progress').style.display = 'none';
    
    console.log('All uploads cleared');
}
</script>
{% endblock %}
